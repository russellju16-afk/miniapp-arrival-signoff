<view class="container">
  <block wx:if="{{loading && !detail}}">
    <view class="card">
      <view class="empty-state">
        <view class="empty-title">单据加载中</view>
        <view class="empty-desc">正在同步签收明细与状态</view>
        <button class="btn-plain" bindtap="refreshData" disabled="{{loading}}">刷新重试</button>
      </view>
    </view>
  </block>

  <block wx:elif="{{errorMessage && !detail}}">
    <view class="card">
      <view class="empty-state">
        <view class="empty-title">单据加载失败</view>
        <view class="empty-desc">{{errorMessage}}</view>
        <view class="cta-row">
          <button class="btn-primary cta-btn" bindtap="refreshData" disabled="{{loading || actionLoading}}">刷新重试</button>
          <button class="btn-plain cta-btn" bindtap="goDeliveries" disabled="{{loading || actionLoading}}">返回列表</button>
        </view>
      </view>
    </view>
  </block>

  <block wx:elif="{{!detail}}">
    <view class="card">
      <view class="empty-state">
        <view class="empty-title">未找到单据</view>
        <view class="empty-desc">可能已处理完成或单据不存在</view>
        <view class="cta-row">
          <button class="btn-primary cta-btn" bindtap="goDeliveries" disabled="{{actionLoading}}">返回列表</button>
          <button class="btn-plain cta-btn" bindtap="refreshData" disabled="{{loading || actionLoading}}">刷新</button>
        </view>
      </view>
    </view>
  </block>

  <block wx:else>
    <view class="card alert-card" wx:if="{{errorMessage}}">
      <view class="sub-title">最近一次刷新失败：{{errorMessage}}</view>
      <button class="btn-plain mini-btn" bindtap="refreshData" disabled="{{loading || actionLoading}}">刷新重试</button>
    </view>

    <view class="card">
      <view class="row section-head">
        <view class="title">单据信息</view>
        <button class="btn-plain mini-btn" bindtap="refreshData" disabled="{{loading || actionLoading}}">刷新</button>
      </view>
      <view class="row">
        <text class="label">单据号</text>
        <text class="value">{{detail.kingdeeBillNumber || detail.kingdee_doc_no || '-'}}</text>
      </view>
      <view class="row">
        <text class="label">发货日期</text>
        <text class="value">{{detail.ship_date_text}}</text>
      </view>
      <view class="row" wx:if="{{detail.orderNo}}">
        <text class="label">订单号</text>
        <text class="value">{{detail.orderNo}}</text>
      </view>
      <view class="row">
        <text class="label">状态</text>
        <text class="value">{{detail.status}}</text>
      </view>
    </view>

    <view class="card">
      <view class="title">商品明细</view>
      <block wx:if="{{items.length === 0}}">
        <view class="empty-state lines-empty">
          <view class="empty-title">暂无明细</view>
          <view class="empty-desc">可刷新重试，或返回列表查看其他单据</view>
          <view class="cta-row">
            <button class="btn-primary cta-btn" bindtap="refreshData" disabled="{{loading || actionLoading}}">刷新重试</button>
            <button class="btn-plain cta-btn" bindtap="goDeliveries" disabled="{{loading || actionLoading}}">返回列表</button>
          </view>
        </view>
      </block>
      <block wx:else>
        <view class="line" wx:for="{{items}}" wx:key="index">
          <view class="line-name">{{item.name || item.material_name || item.sku || ('商品' + (index + 1))}}</view>
          <view class="line-meta">数量：{{item.qty || item.quantity || item.num || '-'}}</view>
        </view>
      </block>
    </view>

    <view class="card" wx:if="{{detail.receipt}}">
      <view class="title">签收信息</view>
      <view class="row">
        <text class="label">签收人</text>
        <text class="value">{{detail.receipt.signer_name}}</text>
      </view>
      <view class="row">
        <text class="label">签收时间</text>
        <text class="value">{{detail.receipt.signed_at_text}}</text>
      </view>
      <view class="row">
        <text class="label">备注</text>
        <text class="value">{{detail.receipt.remark || '-'}}</text>
      </view>
    </view>

    <button
      wx:if="{{detail.status !== 'SIGNED'}}"
      class="btn-primary"
      bindtap="goSign"
      loading="{{actionLoading}}"
      disabled="{{actionLoading}}"
    >
      去签收
    </button>
    <button
      wx:if="{{detail.orderId || detail.salesOrderId || detail.sales_order_id}}"
      class="btn-plain"
      bindtap="goOrderDetail"
      disabled="{{actionLoading}}"
    >
      查看关联订单
    </button>
  </block>
</view>
