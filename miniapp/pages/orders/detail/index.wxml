<view class="container">
  <view class="card" wx:if="{{loading && !order}}">
    <view class="empty-state">
      <view class="empty-title">订单加载中</view>
      <view class="empty-desc">正在同步订单详情与状态</view>
      <button class="btn-plain" bindtap="refreshData" disabled="{{loading}}">刷新重试</button>
    </view>
  </view>

  <view class="card" wx:elif="{{errorMessage && !order}}">
    <view class="empty-state">
      <view class="empty-title">订单加载失败</view>
      <view class="empty-desc">{{errorMessage}}</view>
      <view class="cta-row">
        <button class="btn-primary cta-btn" bindtap="refreshData" disabled="{{loading || actionLoading}}">刷新重试</button>
        <button class="btn-plain cta-btn" bindtap="goOrders" disabled="{{loading || actionLoading}}">返回订单页</button>
      </view>
    </view>
  </view>

  <view class="card" wx:elif="{{!order}}">
    <view class="empty-state">
      <view class="empty-title">订单不存在</view>
      <view class="empty-desc">可能已被删除或无访问权限</view>
      <view class="cta-row">
        <button class="btn-primary cta-btn" bindtap="goOrders" disabled="{{actionLoading}}">返回订单页</button>
        <button class="btn-plain cta-btn" bindtap="refreshData" disabled="{{loading || actionLoading}}">刷新</button>
      </view>
    </view>
  </view>

  <block wx:else>
    <view class="card alert-card" wx:if="{{errorMessage}}">
      <view class="sub-title">最近一次刷新失败：{{errorMessage}}</view>
      <button class="btn-plain mini-btn" bindtap="refreshData" disabled="{{loading || actionLoading || canceling || reordering}}">刷新重试</button>
    </view>

    <view class="card">
      <view class="row section-head">
        <view class="title">{{order.orderNo}}</view>
        <view>
          <view class="status {{order.status === 'CONFIRMED' ? 'status-ok' : (order.status === 'WRITEBACK_FAILED' ? 'status-fail' : 'status-normal')}}">
            {{order.statusText}}
          </view>
          <button class="btn-plain mini-btn refresh-btn" bindtap="refreshData" disabled="{{loading || actionLoading || canceling || reordering}}">刷新</button>
        </view>
      </view>
      <view class="sub-title">下单时间：{{order.createdAtText}}</view>
      <view class="sub-title">更新时间：{{order.updatedAtText}}</view>
      <view class="sub-title">结算方式：{{order.settlementMode}}</view>
      <view class="sub-title">金蝶单号：{{order.kingdeeOrderNumber || '-'}}</view>
      <view class="sub-title">金额：¥{{order.totalAmountText}}</view>
      <view class="sub-title" wx:if="{{order.writebackError}}">写回失败原因：{{order.writebackError}}</view>
      <view class="sub-title" wx:if="{{order.remark}}">备注：{{order.remark}}</view>
    </view>

    <view class="card" wx:if="{{order.deliverySummary.length > 0}}">
      <view class="title">履约信息</view>
      <view class="sub-title" wx:for="{{order.deliverySummary}}" wx:key="*this">{{item}}</view>
    </view>

    <view class="card">
      <view class="title">订单明细</view>
      <view class="line" wx:for="{{order.lines}}" wx:key="id">
        <view class="row">
          <view class="value">{{item.productName}}</view>
          <view class="value">¥{{item.lineAmountText}}</view>
        </view>
        <view class="sub-title">{{item.skuName}}（{{item.skuCode}}）</view>
        <view class="sub-title">数量：{{item.qty}} · 单价：¥{{item.unitPriceText}}</view>
      </view>
    </view>

    <view class="card" wx:if="{{order.canCancel}}">
      <view class="title">取消订单</view>
      <textarea class="textarea" value="{{cancelRemark}}" bindinput="onCancelRemarkInput" placeholder="取消原因（选填）"></textarea>
      <button class="btn-danger" bindtap="cancelOrder" loading="{{canceling}}" disabled="{{canceling || reordering || actionLoading}}">取消订单</button>
    </view>

    <view class="card actions">
      <button class="btn-primary" bindtap="reorder" loading="{{reordering}}" disabled="{{reordering || canceling || actionLoading}}">再次购买</button>
      <button class="btn-plain" bindtap="goInvoiceApply" loading="{{actionLoading}}" disabled="{{reordering || canceling || actionLoading}}">去申请开票</button>
    </view>
  </block>
</view>
