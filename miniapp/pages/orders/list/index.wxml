<view class="container safe-bottom orders-page">
  <view class="card">
    <view class="section-head">
      <view>
        <view class="title">订单列表</view>
        <view class="sub-title">共 {{total}} 单 · 查看写回状态与异常原因</view>
      </view>
      <button class="btn-plain mini-btn" bindtap="refreshList" loading="{{loading && list.length > 0}}" disabled="{{loading}}">刷新</button>
    </view>

    <view class="search-row">
      <input
        class="input"
        value="{{keyword}}"
        bindinput="onKeywordInput"
        bindconfirm="onSearch"
        confirm-type="search"
        placeholder="输入订单号搜索"
      />
      <button class="btn-primary search-btn" bindtap="onSearch" loading="{{searching}}" disabled="{{loading || searching}}">搜索</button>
      <button class="btn-plain search-btn" bindtap="onClearKeyword" disabled="{{loading || searching || !keyword}}">清空</button>
    </view>

    <view class="chip-row status-row">
      <view
        class="chip {{statusValue === item.value ? 'chip-active' : ''}}"
        wx:for="{{statusOptions}}"
        wx:key="value"
        data-value="{{item.value}}"
        bindtap="onTapStatus"
      >
        {{item.label}}
      </view>
    </view>
  </view>

  <view class="card invoice-context">
    <view class="section-head invoice-head">
      <view>
        <view class="title">申请开票</view>
        <view class="sub-title">{{invoiceTip}}</view>
      </view>
      <button class="btn-primary mini-btn" bindtap="goInvoiceRequest" loading="{{invoiceLoading}}" disabled="{{invoiceButtonDisabled}}">申请开票</button>
    </view>
    <view class="sub-title">已选 {{selectedCount}} 单 / 可选 {{selectableCount}} 单</view>
  </view>

  <block wx:if="{{loading && list.length === 0}}">
    <view class="card">
      <view class="empty-state">
        <view class="empty-title">订单加载中</view>
        <view class="empty-desc">正在同步最新订单状态</view>
        <button class="btn-plain" bindtap="refreshList" disabled="{{loading}}">重新加载</button>
      </view>
    </view>
  </block>

  <block wx:elif="{{errorMessage && list.length === 0}}">
    <view class="card">
      <view class="empty-state">
        <view class="empty-title">订单加载失败</view>
        <view class="empty-desc">{{errorMessage}}</view>
        <view class="cta-row">
          <button class="btn-primary cta-btn" bindtap="refreshList" disabled="{{loading}}">刷新重试</button>
          <button class="btn-plain cta-btn" bindtap="onResetFilters" disabled="{{loading}}">清空筛选</button>
        </view>
      </view>
    </view>
  </block>

  <block wx:elif="{{list.length === 0}}">
    <view class="card">
      <view class="empty-state">
        <view class="empty-title">暂无匹配订单</view>
        <view class="empty-desc">可前往商品页下单，或清空筛选后重试</view>
        <view class="cta-row">
          <button class="btn-primary cta-btn" bindtap="goCreateOrder" disabled="{{actionLoading}}">去下单</button>
          <button class="btn-plain cta-btn" bindtap="goProducts" disabled="{{actionLoading}}">去商品页</button>
        </view>
        <button class="btn-plain reset-btn" wx:if="{{keyword || statusValue}}" bindtap="onResetFilters" disabled="{{loading}}">清空筛选</button>
      </view>
    </view>
  </block>

  <block wx:else>
    <view class="card-plain order-item" wx:for="{{list}}" wx:key="id">
      <view class="row order-top">
        <view class="order-select {{item.invoiceSelectable ? '' : 'order-select-disabled'}}" data-id="{{item.id}}" bindtap="onToggleSelect">
          <view class="check {{selectedMap[item.id] ? 'checked' : ''}}">{{selectedMap[item.id] ? '✓' : ''}}</view>
          <view class="sub-title">{{item.invoiceSelectable ? '可开票' : '不可开票'}}</view>
        </view>
        <view class="status-chip {{item.statusChipClass}}">{{item.statusText}}</view>
      </view>

      <view class="value">{{item.orderNo}}</view>
      <view class="sub-title">下单时间：{{item.createdAtText}}</view>
      <view class="sub-title">金额：¥{{item.totalAmountText}}</view>
      <view class="sub-title">金蝶单号：{{item.kingdeeOrderNumber || '-'}}</view>
      <view class="sub-title warn-text" wx:if="{{item.writebackError}}">失败原因：{{item.writebackError}}</view>
      <view class="row item-action-row">
        <button class="btn-plain mini-btn detail-btn" data-id="{{item.id}}" bindtap="goDetail" disabled="{{actionLoading}}">查看详情</button>
      </view>
    </view>

    <view class="list-footer">
      <view class="sub-title" wx:if="{{loading && list.length > 0}}">正在加载更多...</view>
      <view class="sub-title" wx:elif="{{!hasMore && list.length > 0}}">已加载全部订单</view>
    </view>
  </block>
</view>
