<view class="container">
  <view class="card" wx:if="{{loading && !product}}">
    <view class="empty-state">
      <view class="empty-title">商品加载中</view>
      <view class="empty-desc">正在获取商品与规格信息</view>
      <button class="btn-plain" bindtap="refreshData" disabled="{{loading}}">刷新重试</button>
    </view>
  </view>

  <view class="card" wx:elif="{{errorMessage && !product}}">
    <view class="empty-state">
      <view class="empty-title">商品加载失败</view>
      <view class="empty-desc">{{errorMessage}}</view>
      <view class="cta-row">
        <button class="btn-primary cta-btn" bindtap="refreshData" disabled="{{loading || actionLoading}}">刷新重试</button>
        <button class="btn-plain cta-btn" bindtap="goProducts" disabled="{{loading || actionLoading}}">返回商品页</button>
      </view>
    </view>
  </view>

  <view class="card" wx:elif="{{!product}}">
    <view class="empty-state">
      <view class="empty-title">商品不存在</view>
      <view class="empty-desc">可能已下架，请返回商品页查看其他商品</view>
      <view class="cta-row">
        <button class="btn-primary cta-btn" bindtap="goProducts" disabled="{{actionLoading}}">返回商品页</button>
        <button class="btn-plain cta-btn" bindtap="refreshData" disabled="{{loading || actionLoading}}">刷新</button>
      </view>
    </view>
  </view>

  <block wx:else>
    <view class="card alert-card" wx:if="{{errorMessage}}">
      <view class="sub-title">最近一次刷新失败：{{errorMessage}}</view>
      <button class="btn-plain mini-btn" bindtap="refreshData" disabled="{{loading || actionLoading || addCartLoading || quoteSubmitting}}">刷新重试</button>
    </view>

    <view class="card header-card">
      <view class="row section-head">
        <view class="title">{{product.name}}</view>
        <button class="btn-plain mini-btn" bindtap="refreshData" disabled="{{loading || actionLoading || addCartLoading || quoteSubmitting}}">刷新</button>
      </view>
      <view class="sub-title">编码：{{product.code}}</view>
      <view class="sub-title" wx:if="{{product.description}}">{{product.description}}</view>
      <view class="price">{{product.priceText}}</view>
    </view>

    <view class="card">
      <view class="title">规格选择</view>
      <view
        class="sku-row {{selectedSkuId === item.id ? 'sku-row-active' : ''}}"
        wx:for="{{product.skus}}"
        wx:key="id"
        data-id="{{item.id}}"
        bindtap="onSelectSku"
      >
        <view class="row">
          <view class="value">{{item.skuName}}</view>
          <view class="{{item.needQuote ? 'badge-quote' : (item.inStock ? 'badge-ok' : 'badge-warn')}}">
            {{item.needQuote ? '需报价' : item.stockStatusText}}
          </view>
        </view>
        <view class="sub-title">{{item.specsText || '标准规格'}}</view>
        <view class="sub-title">{{item.hasPrice ? ('¥' + item.displayPriceText) : '暂无客户价，请申请报价'}}</view>
      </view>
    </view>

    <view class="card" wx:if="{{selectedSku}}">
      <view class="title">数量</view>
      <view class="qty-wrap">
        <button class="btn-plain qty-btn" bindtap="onMinusQty" disabled="{{loading || actionLoading || addCartLoading || quoteSubmitting}}">-</button>
        <input class="qty-input" value="{{qty}}" type="number" bindinput="onQtyInput" disabled="{{loading || actionLoading || addCartLoading || quoteSubmitting}}" />
        <button class="btn-plain qty-btn" bindtap="onPlusQty" disabled="{{loading || actionLoading || addCartLoading || quoteSubmitting}}">+</button>
      </view>

      <view class="action-row">
        <button class="btn-plain action-btn" bindtap="addToCart" loading="{{addCartLoading}}" disabled="{{loading || actionLoading || addCartLoading || quoteSubmitting}}">加入购物车</button>
        <button class="btn-primary action-btn" bindtap="buyNow" loading="{{actionLoading}}" disabled="{{loading || actionLoading || addCartLoading || quoteSubmitting}}">
          {{selectedSku.needQuote ? '申请报价' : '立即下单'}}
        </button>
      </view>
      <button class="btn-plain" bindtap="submitSingleQuoteRequest" wx:if="{{selectedSku.needQuote}}" loading="{{quoteSubmitting}}" disabled="{{loading || actionLoading || addCartLoading || quoteSubmitting}}">
        仅提交报价申请
      </button>
      <button class="btn-plain" bindtap="goCart" disabled="{{loading || actionLoading || addCartLoading || quoteSubmitting}}">去购物车</button>
    </view>
  </block>
</view>
